<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Карта клиник и лабораторий</title>

  <!-- ВАЖНО: стили для Leaflet, который использует 2ГИС SDK v2 -->
  <link rel="stylesheet" href="https://maps.api.2gis.ru/2.0/leaflet.css" />

  <!-- 2ГИС Web SDK -->
  <script src="https://maps.api.2gis.ru/2.0/loader.js?pkg=full"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .place-label {
      background: rgba(255,255,255,0.9);
      color: #111;
      border: 1px solid rgba(0,0,0,0.25);
      border-radius: 6px;
      padding: 2px 6px;
      font: 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      white-space: nowrap;
    }
    /* убираем «хвостик» у тултипа */
    .leaflet-tooltip.place-label:before { display: none; }

    .controls {
      position: absolute; z-index: 1000; top: 10px; left: 10px;
      background: rgba(255,255,255,0.95); padding: 6px 8px; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      font: 13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .controls label { display: flex; align-items: center; gap: 6px; user-select: none; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <label>
      <input type="checkbox" id="toggleLabels" checked />
      Показывать названия учреждений
    </label>
  </div>

  <script>
    function getParam(name) { const p = new URLSearchParams(location.search); return p.get(name); }
    function parseCenter(val) {
      if (!val) return null;
      const [lat, lon] = val.split(",").map(Number);
      if (isFinite(lat) && isFinite(lon)) return [lat, lon];
      return null;
    }
    function parseMarkers(val) {
      if (!val) return [];
      try {
        const arr = JSON.parse(decodeURIComponent(val));
        if (Array.isArray(arr)) {
          return arr.map(x => ({
            lat: Number(x.lat), lon: Number(x.lon), title: String(x.title ?? "")
          })).filter(x => isFinite(x.lat) && isFinite(x.lon));
        }
      } catch(e) { console.warn("Не удалось распарсить markers:", e); }
      return [];
    }

    const center = parseCenter(getParam("center")) || [55.751244, 37.618423];
    const markers = parseMarkers(getParam("markers"));

    DG.then(function () {
      const map = DG.map('map', { center: center, zoom: markers.length > 1 ? 13 : 14, worldCopyJump: false });
      const group = DG.featureGroup().addTo(map);
      const tooltipRefs = [];

      markers.forEach((m) => {
        const marker = DG.marker([m.lat, m.lon], { title: m.title || "" }).addTo(group);
        const tt = marker.bindTooltip(m.title || "", {
          permanent: true, direction: 'top', offset: [0, -10], className: 'place-label'
        });
        tooltipRefs.push(tt);
        marker.bindPopup(`<b>${escapeHtml(m.title || "Организация")}</b><br/>Координаты: ${m.lat.toFixed(6)}, ${m.lon.toFixed(6)}`);
      });

      if (markers.length > 1) { map.fitBounds(group.getBounds().pad(0.2)); }

      const toggle = document.getElementById("toggleLabels");
      toggle.addEventListener("change", () => {
        tooltipRefs.forEach((tt) => {
          try { toggle.checked ? tt.openTooltip() : tt.closeTooltip(); } catch(e){}
        });
      });

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;").replaceAll("'", "&#39;");
      }
    });
  </script>
</body>
</html>
