<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Карта клиник и лабораторий</title>
    
    <!-- Стили для Leaflet (нужны 2ГИС SDK v2) -->
    <link rel="stylesheet" href="https://maps.api.2gis.ru/2.0/leaflet.css" />
    
    <!-- 2ГИС Web SDK -->
    <script src="https://maps.api.2gis.ru/2.0/loader.js?pkg=full"></script>
    
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        html, body, #map { height: 100%; margin: 0; }
        
        .place-label {
            background: rgba(255,255,255,0.95);
            color: #111;
            border: 1px solid rgba(0,0,0,0.25);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
        }
        
        .error {
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <div id="map">
        <div class="loading" id="loading">Загрузка карты...</div>
    </div>

    <script>
        // Telegram WebApp
        const tg = window.Telegram && window.Telegram.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }
        
        // Получаем данные из URL
        function getData() {
            const params = new URLSearchParams(window.location.search);
            const dataParam = params.get('data');
            
            if (dataParam) {
                try {
                    return JSON.parse(decodeURIComponent(dataParam));
                } catch (e) {
                    console.error('Parse error:', e);
                }
            }
            return null;
        }
        
        // Инициализация карты
        DG.then(function() {
            const loading = document.getElementById('loading');
            const data = getData();
            
            if (!data || !data.clinics || !data.clinics.length) {
                loading.innerHTML = '<span class="error">Нет данных для отображения.<br>Откройте карту из бота.</span>';
                return;
            }
            
            loading.style.display = 'none';
            
            const { userLat, userLon, clinics } = data;
            
            // Создаём карту
            const map = DG.map('map', {
                center: [userLat, userLon],
                zoom: 14
            });
            
            // Маркер пользователя
            DG.marker([userLat, userLon], {
                icon: DG.icon({
                    iconUrl: 'https://maps.api.2gis.ru/2.0/img/geolocation.svg',
                    iconSize: [22, 22]
                })
            }).addTo(map).bindPopup('<b>Вы здесь</b>');
            
            // Маркеры клиник
            const markers = [];
            clinics.forEach(function(clinic) {
                if (!clinic.lat || !clinic.lon) return;
                
                // Текст попапа
                let popupText = '<b>' + clinic.name + '</b><br>' + clinic.address;
                if (clinic.phones && clinic.phones.length) {
                    popupText += '<br><a href="tel:' + clinic.phones[0] + '">' + clinic.phones[0] + '</a>';
                }
                
                // Маркер
                const marker = DG.marker([clinic.lat, clinic.lon])
                    .addTo(map)
                    .bindPopup(popupText);
                
                // Подпись
                const shortName = clinic.name.length > 14 
                    ? clinic.name.substring(0, 14) + '…' 
                    : clinic.name;
                    
                DG.label(shortName, {
                    static: true,
                    className: 'place-label'
                }).setLatLng([clinic.lat, clinic.lon]).addTo(map);
                
                markers.push(marker);
            });
            
            // Подгоняем масштаб
            if (markers.length > 0) {
                const group = DG.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        });
    </script>
</body>
</html>
