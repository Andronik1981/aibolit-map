<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Айболит — карта (2ГИС)</title>

  <!-- Telegram WebApp (для корректной встройки в мини-приложении) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- 2ГИС JS API -->
  <script src="https://maps.api.2gis.ru/2.0/loader.js?pkg=full"></script>

  <style>
    :root { --bg:#ffffff; --fg:#111112; --muted:#6b7280; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--fg);
      font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { position:absolute; inset:0; }
    .hint {
      position:absolute; left:12px; right:12px; top:12px;
      padding:10px 12px; border-radius:8px;
      background:rgba(0,0,0,.06); color:var(--fg); font-size:13px;
    }
    .dg-popup__content { font-size: 13px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="hint" id="hint" style="display:none;"></div>

  <script>
    // Расширяем WebApp на весь экран (если открыто внутри Telegram)
    try { window.Telegram?.WebApp?.expand(); } catch(e) {}

    // Тёмная тема Telegram → подстраиваем фон/текст
    try {
      if (window.Telegram?.WebApp?.colorScheme === 'dark') {
        document.documentElement.style.setProperty('--bg', '#0f0f0f');
        document.documentElement.style.setProperty('--fg', '#e5e7eb');
      }
    } catch(e) {}

    // Безопасное экранирование текста
    function esc(s){
      return String(s || '').replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    // Читаем параметры URL
    const sp = new URLSearchParams(location.search);
    const centerParam = (sp.get('center') || '').split(',').map(Number);

    let places = [];
    try {
      const raw = sp.get('markers');
      if (raw) places = JSON.parse(decodeURIComponent(raw));
    } catch(e) { console.warn('Некорректный markers:', e); }

    // Инициализация 2ГИС карты
    DG.then(function () {
      const startCenter = (centerParam.length === 2 && !centerParam.some(isNaN))
        ? [centerParam[0], centerParam[1]]
        : [55.751244, 37.618423]; // дефолт — центр Москвы

      const map = DG.map('map', { center: startCenter, zoom: 13 });

      // Стили маркеров
      const userIcon = DG.icon({
        // простой кружок через data URI (SVG)
        iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18">
            <circle cx="9" cy="9" r="6" fill="#22c55e" stroke="#ffffff" stroke-width="2"/>
          </svg>`),
        iconSize: [18, 18],
        iconAnchor: [9, 9]
      });

      const placeIcon = DG.icon({
        iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18">
            <circle cx="9" cy="9" r="6" fill="#ef4444" stroke="#ffffff" stroke-width="2"/>
          </svg>`),
        iconSize: [18, 18],
        iconAnchor: [9, 9]
      });

      // Границы для fitBounds
      const bounds = DG.latLngBounds([]);

      // 1) Маркер пользователя (центр)
      if (centerParam.length === 2 && !centerParam.some(isNaN)) {
        DG.marker([centerParam[0], centerParam[1]], { icon: userIcon })
          .addTo(map)
          .bindPopup('<b>Вы здесь</b>');
        bounds.extend([centerParam[0], centerParam[1]]);
      }

      // 2) Маркеры организаций
      (places || []).forEach(p => {
        const lat = Number(p.lat), lon = Number(p.lon);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
        const name = esc(p.title || p.name || 'Организация');
        const addr = esc(p.address || '');
        const html = addr ? `<b>${name}</b><div style="margin-top:4px;color:#6b7280;">${addr}</div>` : `<b>${name}</b>`;

        DG.marker([lat, lon], { icon: placeIcon }).addTo(map).bindPopup(html);
        bounds.extend([lat, lon]);
      });

      if (bounds.isValid()) {
        map.fitBounds(bounds, { padding: [30, 30] });
      } else {
        map.setView(startCenter, 13);
        const hint = document.getElementById('hint');
        hint.textContent = 'Маркеров не передано. Откройте карту из чата повторно.';
        hint.style.display = 'block';
      }
    });
  </script>
</body>
</html>
