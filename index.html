<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>–ö–∞—Ä—Ç–∞ –∫–ª–∏–Ω–∏–∫ –∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–π</title>
    
    <!-- –°—Ç–∏–ª–∏ –¥–ª—è Leaflet (2–ì–ò–° SDK v2) -->
    <link rel="stylesheet" href="https://maps.api.2gis.ru/2.0/leaflet.css" />
    
    <!-- 2–ì–ò–° Web SDK -->
    <script src="https://maps.api.2gis.ru/2.0/loader.js?pkg=full"></script>
    
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        html, body, #map { height: 100%; margin: 0; }
        
        .place-label {
            background: rgba(255,255,255,0.95);
            color: #111;
            border: 1px solid rgba(0,0,0,0.25);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
        }
        
        .error { color: #d32f2f; }
    </style>
</head>
<body>
    <div id="map">
        <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
    </div>

    <script>
        // Telegram WebApp
        const tg = window.Telegram && window.Telegram.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ URL (–¥–≤–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è)
        function getData() {
            const params = new URLSearchParams(window.location.search);
            
            // –§–æ—Ä–º–∞—Ç 1: ?data={json}
            const dataParam = params.get('data');
            if (dataParam) {
                try {
                    return JSON.parse(decodeURIComponent(dataParam));
                } catch (e) {
                    console.error('Parse data error:', e);
                }
            }
            
            // –§–æ—Ä–º–∞—Ç 2: ?center=lat,lon&markers=[{...}]
            const center = params.get('center');
            const markers = params.get('markers');
            if (center && markers) {
                try {
                    const [lat, lon] = center.split(',').map(Number);
                    const clinics = JSON.parse(decodeURIComponent(markers)).map(m => ({
                        name: m.title || m.name,
                        address: m.address || '',
                        lat: m.lat,
                        lon: m.lon,
                        phones: m.phones || []
                    }));
                    return { userLat: lat, userLon: lon, clinics };
                } catch (e) {
                    console.error('Parse center/markers error:', e);
                }
            }
            
            return null;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        DG.then(function() {
            const loading = document.getElementById('loading');
            const data = getData();
            
            if (!data || !data.clinics || !data.clinics.length) {
                loading.innerHTML = '<span class="error">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.<br>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞—Ä—Ç—É –∏–∑ –±–æ—Ç–∞.</span>';
                return;
            }
            
            loading.style.display = 'none';
            
            const { userLat, userLon, clinics } = data;
            
            // –°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É
            const map = DG.map('map', {
                center: [userLat, userLon],
                zoom: 13
            });
            
            // –ú–∞—Ä–∫–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–∏–Ω–∏–π –∫—Ä—É–≥)
            DG.circleMarker([userLat, userLon], {
                radius: 10,
                color: '#2196F3',
                fillColor: '#2196F3',
                fillOpacity: 0.8,
                weight: 3
            }).addTo(map).bindPopup('<b>–í—ã –∑–¥–µ—Å—å</b>');
            
            // –ú–∞—Ä–∫–µ—Ä—ã –∫–ª–∏–Ω–∏–∫
            const markers = [];
            const bounds = [[userLat, userLon]];
            
            clinics.forEach(function(clinic, index) {
                if (!clinic.lat || !clinic.lon) return;
                
                bounds.push([clinic.lat, clinic.lon]);
                
                // –¢–µ–∫—Å—Ç –ø–æ–ø–∞–ø–∞
                let popupText = '<b>' + clinic.name + '</b>';
                if (clinic.address) {
                    popupText += '<br>üìç ' + clinic.address;
                }
                if (clinic.phones && clinic.phones.length) {
                    popupText += '<br><a href="tel:' + clinic.phones[0].replace(/[^\d+]/g, '') + '">üìû ' + clinic.phones[0] + '</a>';
                }
                
                // –ö—Ä–∞—Å–Ω—ã–π –º–∞—Ä–∫–µ—Ä
                const marker = DG.marker([clinic.lat, clinic.lon], {
                    icon: DG.icon({
                        iconUrl: 'https://maps.api.2gis.ru/2.0/img/cluster-marker.png',
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    })
                }).addTo(map).bindPopup(popupText);
                
                markers.push(marker);
                
                // –ü–æ–¥–ø–∏—Å—å (—Å–æ–∫—Ä–∞—â–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è)
                const maxLen = 14;
                const shortName = clinic.name.length > maxLen 
                    ? clinic.name.substring(0, maxLen) + '‚Ä¶' 
                    : clinic.name;
                    
                DG.divIcon({
                    className: 'place-label',
                    html: shortName,
                    iconSize: null
                });
            });
            
            // –ü–æ–¥–≥–æ–Ω—è–µ–º –º–∞—Å—à—Ç–∞–± —á—Ç–æ–±—ã –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –±—ã–ª–∏ –≤–∏–¥–Ω—ã
            if (bounds.length > 1) {
                map.fitBounds(bounds, { padding: [30, 30] });
            }
        });
    </script>
</body>
</html>
