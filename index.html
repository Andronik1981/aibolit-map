<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>–ö–∞—Ä—Ç–∞ –∫–ª–∏–Ω–∏–∫</title>
    <link rel="stylesheet" href="https://maps.api.2gis.ru/2.0/leaflet.css" />
    <script src="https://maps.api.2gis.ru/2.0/loader.js?pkg=full"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        html, body, #map { height: 100%; margin: 0; }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
        }
        .error { color: #d32f2f; }
    </style>
</head>
<body>
    <div id="map">
        <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
    </div>
    <script>
        const tg = window.Telegram && window.Telegram.WebApp;
        if (tg) { tg.ready(); tg.expand(); }
        
        function getData() {
            const params = new URLSearchParams(window.location.search);
            
            // New compact format: ?d={...}
            const d = params.get('d');
            if (d) {
                try {
                    const data = JSON.parse(decodeURIComponent(d));
                    return {
                        userLat: data.u[0],
                        userLon: data.u[1],
                        clinics: data.c.map(c => ({
                            name: c.n,
                            address: c.a,
                            lat: c.lt,
                            lon: c.ln
                        }))
                    };
                } catch (e) { console.error('Parse d error:', e); }
            }
            
            // Old format: ?data={...}
            const dataParam = params.get('data');
            if (dataParam) {
                try {
                    return JSON.parse(decodeURIComponent(dataParam));
                } catch (e) { console.error('Parse data error:', e); }
            }
            
            // Legacy format: ?center=...&markers=...
            const center = params.get('center');
            const markers = params.get('markers');
            if (center && markers) {
                try {
                    const [lat, lon] = center.split(',').map(Number);
                    const clinics = JSON.parse(decodeURIComponent(markers)).map(m => ({
                        name: m.title || m.name,
                        address: m.address || '',
                        lat: m.lat,
                        lon: m.lon
                    }));
                    return { userLat: lat, userLon: lon, clinics };
                } catch (e) { console.error('Parse legacy error:', e); }
            }
            
            return null;
        }
        
        DG.then(function() {
            const loading = document.getElementById('loading');
            const data = getData();
            
            if (!data || !data.clinics || !data.clinics.length) {
                loading.innerHTML = '<span class="error">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.<br>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞—Ä—Ç—É –∏–∑ –±–æ—Ç–∞.</span>';
                return;
            }
            
            loading.style.display = 'none';
            const { userLat, userLon, clinics } = data;
            
            const map = DG.map('map', { center: [userLat, userLon], zoom: 13 });
            
            // User marker
            DG.circleMarker([userLat, userLon], {
                radius: 10, color: '#2196F3', fillColor: '#2196F3', fillOpacity: 0.8, weight: 3
            }).addTo(map).bindPopup('<b>–í—ã –∑–¥–µ—Å—å</b>');
            
            // Clinic markers
            const bounds = [[userLat, userLon]];
            clinics.forEach(function(clinic) {
                if (!clinic.lat || !clinic.lon) return;
                bounds.push([clinic.lat, clinic.lon]);
                
                let popup = '<b>' + clinic.name + '</b>';
                if (clinic.address) popup += '<br>üìç ' + clinic.address;
                
                DG.marker([clinic.lat, clinic.lon]).addTo(map).bindPopup(popup);
            });
            
            if (bounds.length > 1) {
                map.fitBounds(bounds, { padding: [30, 30] });
            }
        });
    </script>
</body>
</html>
