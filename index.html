<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏</title>
    
    <!-- 2GIS MapGL API -->
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .clinic-popup {
            padding: 8px 12px;
            max-width: 280px;
        }
        
        .clinic-popup h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #1a1a1a;
            line-height: 1.3;
        }
        
        .clinic-popup .address {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .clinic-popup .phone {
            font-size: 13px;
            color: #2196F3;
            text-decoration: none;
            display: inline-block;
            margin-top: 4px;
        }
        
        .clinic-popup .phone:hover {
            text-decoration: underline;
        }
        
        .clinic-popup .route-btn {
            display: inline-block;
            margin-top: 8px;
            padding: 6px 12px;
            background: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #f44336;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="map">
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
        </div>
    </div>

    <script>
        // Initialize Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // Apply Telegram theme
        document.body.style.backgroundColor = tg.backgroundColor || '#ffffff';
        
        // Parse data from URL or Telegram
        function getClinicData() {
            // Try to get data from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            
            if (dataParam) {
                try {
                    return JSON.parse(decodeURIComponent(dataParam));
                } catch (e) {
                    console.error('Error parsing URL data:', e);
                }
            }
            
            // Try to get data from Telegram WebApp
            if (tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
                try {
                    return JSON.parse(decodeURIComponent(tg.initDataUnsafe.start_param));
                } catch (e) {
                    console.error('Error parsing Telegram data:', e);
                }
            }
            
            // Try hash parameter
            const hash = window.location.hash.substring(1);
            if (hash) {
                try {
                    return JSON.parse(decodeURIComponent(hash));
                } catch (e) {
                    console.error('Error parsing hash data:', e);
                }
            }
            
            return null;
        }
        
        // Initialize map
        async function initMap() {
            const loading = document.getElementById('loading');
            
            const data = getClinicData();
            
            if (!data || !data.clinics || data.clinics.length === 0) {
                loading.innerHTML = '<div class="error-message">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.<br>–í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –±–æ—Ç –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∏—Å–∫.</div>';
                return;
            }
            
            const { userLat, userLon, clinics } = data;
            
            try {
                // Create map centered on user location
                const map = new mapgl.Map('map', {
                    center: [userLon, userLat],
                    zoom: 14,
                    key: 'b0f89628-c385-4f63-a91f-3d0242ff4872'
                });
                
                loading.style.display = 'none';
                
                // Add user location marker
                new mapgl.Marker(map, {
                    coordinates: [userLon, userLat],
                    icon: 'https://docs.2gis.com/img/mapgl/marker.svg',
                    size: [32, 32],
                    anchor: [16, 32]
                });
                
                // Add markers for each clinic
                const markers = [];
                clinics.forEach((clinic, index) => {
                    if (!clinic.lat || !clinic.lon) return;
                    
                    const marker = new mapgl.Marker(map, {
                        coordinates: [clinic.lon, clinic.lat],
                        icon: 'https://docs.2gis.com/img/mapgl/marker-hospital.svg',
                        size: [28, 28],
                        anchor: [14, 28],
                        label: {
                            text: clinic.name.length > 20 ? clinic.name.substring(0, 20) + '...' : clinic.name,
                            offset: [0, -35],
                            fontSize: 11,
                            color: '#333'
                        }
                    });
                    
                    // Click handler for marker
                    marker.on('click', () => {
                        showClinicInfo(clinic, userLat, userLon);
                    });
                    
                    markers.push(marker);
                });
                
                // Fit map to show all markers
                if (markers.length > 0) {
                    const bounds = [
                        [userLon, userLat],
                        ...clinics.filter(c => c.lat && c.lon).map(c => [c.lon, c.lat])
                    ];
                    
                    // Calculate bounds
                    let minLon = bounds[0][0], maxLon = bounds[0][0];
                    let minLat = bounds[0][1], maxLat = bounds[0][1];
                    
                    bounds.forEach(([lon, lat]) => {
                        minLon = Math.min(minLon, lon);
                        maxLon = Math.max(maxLon, lon);
                        minLat = Math.min(minLat, lat);
                        maxLat = Math.max(maxLat, lat);
                    });
                    
                    // Add padding
                    const padding = 0.01;
                    map.fitBounds({
                        southWest: [minLon - padding, minLat - padding],
                        northEast: [maxLon + padding, maxLat + padding]
                    });
                }
                
            } catch (error) {
                console.error('Map initialization error:', error);
                loading.innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã.<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>';
            }
        }
        
        // Show clinic info popup
        function showClinicInfo(clinic, userLat, userLon) {
            let phonesHtml = '';
            if (clinic.phones && clinic.phones.length > 0) {
                phonesHtml = clinic.phones.map(p => 
                    `<a href="tel:${p.replace(/[^\d+]/g, '')}" class="phone">üìû ${p}</a>`
                ).join('<br>');
            }
            
            const routeUrl = `https://2gis.ru/search/${encodeURIComponent(clinic.name)}/route/${userLon},${userLat}/${clinic.lon},${clinic.lat}`;
            
            // Use Telegram popup
            tg.showPopup({
                title: clinic.name,
                message: `üìç ${clinic.address}\n\n${clinic.phones ? 'üìû ' + clinic.phones.join(', ') : ''}`,
                buttons: [
                    { id: 'route', type: 'default', text: 'üöó –ú–∞—Ä—à—Ä—É—Ç' },
                    { id: 'close', type: 'cancel', text: '–ó–∞–∫—Ä—ã—Ç—å' }
                ]
            }, (buttonId) => {
                if (buttonId === 'route') {
                    tg.openLink(routeUrl);
                }
            });
        }
        
        // Start
        initMap();
    </script>
</body>
</html>
