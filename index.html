<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Карта клиник и лабораторий</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    /* Стиль подписи у маркера (перманентный tooltip) */
    .place-label {
      background: rgba(255,255,255,0.9);
      color: #111;
      border: 1px solid rgba(0,0,0,0.25);
      border-radius: 6px;
      padding: 2px 6px;
      font: 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      white-space: nowrap;
    }
    .place-label:before { display: none; } /* убираем «хвостик» */
    /* Небольшие отступы, если подпись длинная */
    @media (max-width: 420px) {
      .place-label { font-size: 12px; }
    }

    /* Кнопка/переключатель подписи (по желанию можно скрыть) */
    .controls {
      position: absolute; z-index: 1000; top: 10px; left: 10px;
      background: rgba(255,255,255,0.95); padding: 6px 8px; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15); font: 13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .controls label { display: flex; align-items: center; gap: 6px; user-select: none; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <label>
      <input type="checkbox" id="toggleLabels" checked />
      Показывать названия учреждений
    </label>
  </div>

  <script>
    // --- утилиты для чтения параметров ---
    function getParam(name) {
      const p = new URLSearchParams(location.search);
      return p.get(name);
    }
    function parseCenter(val) {
      // формат "lat,lon"
      if (!val) return null;
      const [lat, lon] = val.split(",").map(Number);
      if (isFinite(lat) && isFinite(lon)) return [lat, lon];
      return null;
    }
    function parseMarkers(val) {
      // ожидаем JSON-массив объектов {lat, lon, title}
      if (!val) return [];
      try {
        const arr = JSON.parse(decodeURIComponent(val));
        if (Array.isArray(arr)) {
          return arr
            .map(x => ({
              lat: Number(x.lat),
              lon: Number(x.lon),
              title: String(x.title ?? "")
            }))
            .filter(x => isFinite(x.lat) && isFinite(x.lon));
        }
      } catch(e) {
        console.warn("Не удалось распарсить markers:", e);
      }
      return [];
    }

    const center = parseCenter(getParam("center")) || [55.751244, 37.618423]; // запасной центр — Москва
    const markers = parseMarkers(getParam("markers"));

    // --- карта ---
    const map = L.map("map", { zoomControl: true }).setView(center, 13);

    // Подложка (OpenStreetMap; можно заменить на любую другую)
    const osm = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
      }
    );
    osm.addTo(map);

    // Храним ссылки на тултипы, чтобы уметь «прятать/показывать» названия
    const tooltipRefs = [];

    // Добавляем маркеры
    const group = L.featureGroup().addTo(map);

    markers.forEach((m) => {
      const marker = L.marker([m.lat, m.lon], { title: m.title || "" }).addTo(group);

      // Перманентная подпись поверх маркера
      const tt = marker.bindTooltip(m.title || "", {
        permanent: true,
        direction: "top",
        offset: [0, -10],
        className: "place-label"
      });
      tooltipRefs.push(tt);

      // Клик по маркеру — показываем всплывашку с адресом/названием
      marker.bindPopup(
        `<b>${escapeHtml(m.title || "Организация")}</b><br/>Координаты: ${m.lat.toFixed(6)}, ${m.lon.toFixed(6)}`
      );
    });

    // Авто-масштаб, если есть точки
    if (markers.length > 1) {
      map.fitBounds(group.getBounds().pad(0.2));
    } else {
      map.setView(center, 14);
    }

    // Переключатель «показывать названия»
    const toggle = document.getElementById("toggleLabels");
    toggle.addEventListener("change", () => {
      tooltipRefs.forEach((tt) => {
        if (toggle.checked) {
          // show
          const m = tt._source; // исходный маркер
          if (m && tt._tooltip && !map.hasLayer(tt._tooltip)) {
            tt.openTooltip();
          }
        } else {
          // hide
          tt.closeTooltip();
        }
      });
    });

    // Вспомогательная функция экранирования HTML
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
  </script>
</body>
</html>
