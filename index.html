<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Карта 2GIS — Aibolit</title>
  <script src="https://maps.api.2gis.ru/2.0/loader.js?pkg=full"></script>
  <style>
    html, body, #map { margin:0; padding:0; width:100%; height:100vh; }
  </style>
</head>
<body>
<div id="map"></div>
<script>
DG.then(function () {
  const params = new URLSearchParams(window.location.search);
  const centerParam  = params.get('center');     // "lat,lon"
  const markersParam = params.get('markers');    // URL-encoded JSON

  // 1) Центр: если не пришёл, ставим дефолт (Москва)
  let center = [55.751244, 37.618423];
  if (centerParam && centerParam.includes(',')) {
    const [lat, lon] = centerParam.split(',').map(Number);
    if (isFinite(lat) && isFinite(lon)) center = [lat, lon];
  }

  const map = DG.map('map', { center, zoom: 13 });

  // 2) Маркеры
  let markers = [];
  if (markersParam) {
    try {
      markers = JSON.parse(decodeURIComponent(markersParam));
      if (!Array.isArray(markers)) markers = [];
    } catch (e) {
      console.error('Invalid markers:', e);
      markers = [];
    }
  }

  const group = DG.featureGroup().addTo(map);

  // Опционально: отметим центр пользователя
  DG.circleMarker(center, { radius: 6 }).addTo(group).bindPopup('Вы здесь');

  markers.forEach(m => {
    if (typeof m !== 'object') return;
    const lat = Number(m.lat), lon = Number(m.lon);
    if (!isFinite(lat) || !isFinite(lon)) return;

    DG.marker([lat, lon]).addTo(group).bindPopup(`<b>${m.title ?? 'Объект'}</b>`);
  });

  // 3) Автоподгонка масштаба
  if (group.getLayers().length > 1) {
    map.fitBounds(group.getBounds(), { padding: [30, 30] });
  }
});
</script>
</body>
</html>
