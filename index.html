<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Карта клиник и лабораторий</title>

  <!-- Стили для Leaflet (нужны 2ГИС SDK v2) -->
  <link rel="stylesheet" href="https://maps.api.2gis.ru/2.0/leaflet.css" />
  <!-- 2ГИС Web SDK -->
  <script src="https://maps.api.2gis.ru/2.0/loader.js?pkg=full"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    /* Вид перманентных подписей */
    .place-label {
      background: rgba(255,255,255,0.95);
      color: #111;
      border: 1px solid rgba(0,0,0,0.25);
      border-radius: 6px;
      padding: 2px 6px;
      font: 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
      white-space: nowrap;
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
      pointer-events: none; /* не мешаем кликам */
    }
    .leaflet-tooltip.place-label:before { display: none; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    /* ====== ПАРАМЕТРЫ (можно подстроить) ====== */
    const MAX_LEN       = 28; // длина подписи (остаток — «…»)
    const DEFAULT_ZOOM  = 14; // масштаб, если маркер один

    /* ============== Утилиты и ввод из URL ============== */
    function getParam(name) { const p = new URLSearchParams(location.search); return p.get(name); }
    function parseCenter(val) {
      if (!val) return null;
      const [lat, lon] = val.split(",").map(Number);
      if (isFinite(lat) && isFinite(lon)) return [lat, lon];
      return null;
    }
    function parseMarkers(val) {
      if (!val) return [];
      try {
        const arr = JSON.parse(decodeURIComponent(val));
        if (Array.isArray(arr)) {
          return arr
            .map(x => ({
              lat: Number(x.lat), lon: Number(x.lon), title: String(x.title ?? "").trim()
            }))
            .filter(x => isFinite(x.lat) && isFinite(x.lon));
        }
      } catch(e) { console.warn("Не удалось распарсить markers:", e); }
      return [];
    }
    const escapeHtml = (s) => String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
    const ellipsis = (s, n) => s && s.length > n ? (s.slice(0, n-1) + "…") : (s || "");

    const center  = parseCenter(getParam("center")) || [55.751244, 37.618423];
    const markers = parseMarkers(getParam("markers"));

    /* ============================ Карта 2ГИС ============================ */
    DG.then(function () {
      const map   = DG.map('map', { center: center, zoom: markers.length > 1 ? 13 : DEFAULT_ZOOM });
      const group = DG.featureGroup().addTo(map);

      // item: { marker, fullTitle, tooltipInst, dom, shortTitle }
      const labelItems = [];

      // 1) Маркеры + popup + постоянная подпись
      markers.forEach((m) => {
        const fullTitle  = m.title || "Организация";
        const marker     = DG.marker([m.lat, m.lon], { title: fullTitle }).addTo(group);
        marker.bindPopup(
          `<b>${escapeHtml(fullTitle)}</b><br/>Координаты: ${m.lat.toFixed(6)}, ${m.lon.toFixed(6)}`
        );

        const shortTitle = ellipsis(fullTitle, MAX_LEN);
        marker.bindTooltip(shortTitle, {
          permanent: true,
          direction: 'top',
          offset: [0, -10],
          className: 'place-label'
        });

        labelItems.push({ marker, fullTitle, tooltipInst: null, dom: null, shortTitle });
      });

      if (markers.length > 1) {
        map.fitBounds(group.getBounds().pad(0.2));
      }

      // 2) Получаем инстансы тултипов и DOM-контейнеры
      function updateDomRefs() {
        labelItems.forEach(item => {
          try {
            if (!item.marker.getTooltip()) item.marker.openTooltip();
            const tt = item.marker.getTooltip ? item.marker.getTooltip() : item.marker._tooltip;
            item.tooltipInst = tt || null;
            item.dom = tt && tt._container ? tt._container : null;
            if (item.dom) item.dom.classList.remove('hidden'); // всегда показываем (дальше только анти-коллизии)
          } catch(e) {
            item.tooltipInst = null; item.dom = null;
          }
        });
      }

      // 3) Применяем длину (если будешь менять MAX_LEN)
      function refreshShortTitles() {
        labelItems.forEach(item => {
          item.shortTitle = ellipsis(item.fullTitle, MAX_LEN);
          try { item.tooltipInst && item.tooltipInst.setContent(item.shortTitle); } catch(e){}
        });
      }

      // 4) Простая анти-коллизия (прячем пересекающиеся ярлыки)
      function resolveCollisions() {
        const visibles = labelItems
          .map(x => ({...x, rect: x.dom?.getBoundingClientRect()}))
          .filter(x => x.rect);

        // короткие подписи — приоритетнее (меньше закрывают карту)
        visibles.sort((a,b) => a.shortTitle.length - b.shortTitle.length);

        const taken = [];
        for (const it of visibles) {
          const r = it.rect;
          let overlap = false;
          for (const tr of taken) {
            if (!(r.right < tr.left || r.left > tr.right || r.bottom < tr.top || r.top > tr.bottom)) {
              overlap = true; break;
            }
          }
          if (overlap) {
            it.dom.classList.add('hidden');
          } else {
            it.dom.classList.remove('hidden');
            taken.push(r);
          }
        }
      }

      function fullRelayout() {
        refreshShortTitles();
        updateDomRefs();
        resolveCollisions();
      }

      // Первичная раскладка
      setTimeout(fullRelayout, 120);
      // Пересчёт при движении/зуме
      map.on('zoomend moveend', () => setTimeout(fullRelayout, 0));
    });
  </script>
</body>
</html>
